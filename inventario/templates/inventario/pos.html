{% extends 'inventario/base.html' %}
{% load static %}

{% block title %}Punto de Venta Ferretero PRO{% endblock %}

{% block extra_styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .pos-container { max-width: 100%; }
    .pos-header { background-color: #212529; color: #ffc107; padding: 15px; border-radius: 8px 8px 0 0; }
    .total-big { font-size: 3.5rem; font-weight: 800; color: #198754; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
    /* Resaltado para el selector de pago */
    .payment-method-box { background-color: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- COLUMNA IZQUIERDA: B√öSQUEDA Y CARRITO -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body bg-light">
                <!-- BARRAS Y B√öSQUEDA -->
                <div class="row g-2 mb-2">
                    <div class="col-md-12">
                         <div class="input-group input-group-lg">
                            <span class="input-group-text bg-warning"><i class="fas fa-barcode"></i></span>
                            <input type="text" id="barcode_input" class="form-control fw-bold" placeholder="Escanear C√≥digo de Barras (Enter)" autofocus>
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <label class="fw-bold text-muted small text-uppercase">Material / Herramienta / Cable</label>
                        <select id="producto" class="form-select form-select-lg"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="fw-bold text-muted small text-uppercase">Cantidad</label>
                        <!-- step="any" es vital para ferreter√≠as (ej: 2.50 metros de cable) -->
                        <input type="number" id="cantidad" class="form-control form-control-lg text-center fw-bold" value="1" min="0.01" step="any">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button id="btn-add-to-cart" class="btn btn-primary btn-lg"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE CARRITO -->
        <div class="card shadow border-0" style="min-height: 500px;">
            <div class="card-header pos-header d-flex justify-content-between align-items-center">
                <span class="h5 mb-0"><i class="fas fa-shopping-cart"></i> DETALLE DE VENTA</span>
                <span class="badge bg-warning text-dark" id="items-count">0 √çtems</span>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-secondary">
                        <tr>
                            <th>Descripci√≥n</th>
                            <th class="text-center" width="10%">Unid.</th>
                            <th class="text-center" width="15%">Cant.</th>
                            <th class="text-end" width="15%">P. Unit</th>
                            <th class="text-end" width="15%">Subtotal</th>
                            <th class="text-center" width="10%"></th>
                        </tr>
                    </thead>
                    <tbody id="cart-items"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- COLUMNA DERECHA: TOTALES, CLIENTE Y PAGO -->
    <div class="col-lg-4">
        <!-- TARJETA TOTAL -->
        <div class="card shadow border-0 mb-4">
            <div class="card-body bg-white p-4">
                <h6 class="text-muted text-center fw-bold text-uppercase ls-1">Total a Pagar</h6>
                <div id="grand-total-display" class="total-big">S/ 0.00</div>
                <hr>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Subtotal: <span id="subtotal-display">S/ 0.00</span></span>
                    <span>IGV (18%): <span id="igv-display">S/ 0.00</span></span>
                </div>
            </div>
        </div>

        <!-- FORMULARIO CLIENTE Y FORMA DE PAGO -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3 border-bottom pb-2"><i class="fas fa-user-check"></i> Finalizar Venta</h5>
                
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">CLIENTE</label>
                    <div class="input-group shadow-sm">
                        <select id="cliente" class="form-select"></select>
                        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalNuevoCliente">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                </div>

                <!-- NUEVO: SELECTOR DE FORMA DE PAGO -->
                <div class="payment-method-box mb-3">
                    <label class="form-label fw-bold text-dark small text-uppercase">Forma de Pago</label>
                    <select id="metodo_pago" class="form-select form-select-lg border-warning fw-bold">
                        <option value="EFECTIVO">üíµ EFECTIVO</option>
                        <option value="TRANSFERENCIA">üì± TRANSFERENCIA / PLIN</option>
                        <option value="CREDITO">üí≥ CR√âDITO (F√çAO / DEUDA)</option>
                    </select>
                    <div id="msg-credito" class="text-danger small mt-2 fw-bold" style="display:none;">
                        * Se cargar√° al saldo deudor del cliente.
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">OBSERVACIONES / NOTA</label>
                    <textarea id="observaciones" class="form-control" rows="2" placeholder="Ej: Maestro Juan, entrega lunes..."></textarea>
                </div>

                <div class="d-grid gap-3 mt-4">
                    <button class="btn btn-success btn-lg fw-bold py-3 shadow" onclick="emitir('BOLETA')">
                        <i class="fas fa-receipt me-2"></i> EMITIR BOLETA
                    </button>
                    <button class="btn btn-primary btn-lg fw-bold py-3 shadow" onclick="emitir('FACTURA')">
                        <i class="fas fa-file-invoice-dollar me-2"></i> EMITIR FACTURA
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE REGISTRO R√ÅPIDO DE CLIENTE (DIVIDIDO) -->
<div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Registro R√°pido de Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-cliente">
                    <div class="row">
                        <div class="col-md-6 border-end">
                            <h6 class="fw-bold text-primary border-bottom pb-2">Persona (Boleta)</h6>
                            <div class="mb-2">
                                <label class="small fw-bold">Nombre Completo</label>
                                <input type="text" id="reg_nombre" class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <label class="small fw-bold">DNI</label>
                                <input type="text" id="reg_dni" class="form-control form-control-sm" maxlength="8">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6 class="fw-bold text-success border-bottom pb-2">Empresa (Factura)</h6>
                            <div class="mb-2">
                                <label class="small fw-bold">Raz√≥n Social</label>
                                <input type="text" id="reg_razon" class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <label class="small fw-bold">RUC</label>
                                <input type="text" id="reg_ruc" class="form-control form-control-sm" maxlength="11">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-guardar-cliente-rapido">Guardar y Seleccionar</button>
            </div>
        </div>
    </div>
</div>

<div id="mensaje-ajax" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 9999;" class="alert alert-success shadow-lg"></div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let shoppingCart = [];
    const productosData = {{ productos_json|safe }};
    
    const clientesData = [ 
        { id: '', text: 'Cliente General (P√∫blico)', ruc: '', razon: '' }, 
        {% for cliente in clientes %} 
        { 
            id: {{ cliente.id }}, 
            text: "{{ cliente|escapejs }}", 
            ruc: "{{ cliente.ruc|default:'' }}", 
            razon: "{{ cliente.razon_social|default:'' }}" 
        }{% if not forloop.last %},{% endif %} 
        {% endfor %} 
    ];

    $(document).ready(function() {
        $('#producto').select2({ data: productosData, placeholder: "Buscar material...", width: '100%' });
        $('#cliente').select2({ data: clientesData, width: '100%' });

        $('#metodo_pago').change(function() {
            if($(this).val() === 'CREDITO') $('#msg-credito').fadeIn();
            else $('#msg-credito').fadeOut();
        });

        $('#btn-add-to-cart').click(agregarAlCarrito);

        $('#barcode_input').on('keypress', function(e) {
            if (e.which == 13) {
                const code = $(this).val().trim();
                const prod = productosData.find(p => p.codigo_barras === code);
                if(prod) {
                    $('#producto').val(prod.id).trigger('change');
                    agregarAlCarrito();
                    $(this).val('');
                }
            }
        });

        $('#btn-guardar-cliente-rapido').click(function() {
            const data = {
                nombre: $('#reg_nombre').val(),
                dni: $('#reg_dni').val(),
                razon: $('#reg_razon').val(),
                ruc: $('#reg_ruc').val()
            };
            $.ajax({
                url: "{% url 'inventario:crear_cliente_ajax' %}",
                method: "POST",
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function(response) {
                    clientesData.push({ id: response.id, text: response.text, ruc: response.ruc, razon: response.razon });
                    $('#cliente').append(new Option(response.text, response.id, true, true)).trigger('change');
                    bootstrap.Modal.getInstance(document.getElementById('modalNuevoCliente')).hide();
                }
            });
        });
    });

    function agregarAlCarrito() {
        const prodId = $('#producto').val();
        const qty = parseFloat($('#cantidad').val());
        if(!prodId || isNaN(qty) || qty <= 0) return alert("Seleccione producto y cantidad v√°lida");

        const prodInfo = productosData.find(p => p.id == prodId);
        // Extraemos la unidad de medida si existe en el texto (ej: "Cable (Stock: 10) [MTS]")
        const unit = prodInfo.text.includes('[') ? prodInfo.text.split('[')[1].replace(']', '') : 'UND';

        const existingIdx = shoppingCart.findIndex(i => i.id == prodId);
        if(existingIdx > -1) {
            shoppingCart[existingIdx].quantity += qty;
        } else {
            shoppingCart.push({
                id: prodInfo.id,
                name: prodInfo.text.split(' (Stock:')[0],
                quantity: qty,
                price: parseFloat(prodInfo.price || prodInfo.precio),
                unit: unit
            });
        }
        renderizarCarrito();
        $('#cantidad').val(1);
    }

    function renderizarCarrito() {
        const tbody = $('#cart-items');
        tbody.empty();
        let total = 0;
        shoppingCart.forEach((item, index) => {
            const subtotal = item.quantity * item.price;
            total += subtotal;
            tbody.append(`
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center text-muted small">${item.unit}</td>
                    <td class="text-center fw-bold">${item.quantity}</td>
                    <td class="text-end">S/ ${item.price.toFixed(2)}</td>
                    <td class="text-end fw-bold">S/ ${subtotal.toFixed(2)}</td>
                    <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="eliminarItem(${index})"><i class="fas fa-trash"></i></button></td>
                </tr>
            `);
        });
        $('#grand-total-display').text('S/ ' + total.toFixed(2));
        $('#subtotal-display').text('S/ ' + (total / 1.18).toFixed(2));
        $('#igv-display').text('S/ ' + (total - (total/1.18)).toFixed(2));
        $('#items-count').text(shoppingCart.length + ' √çtems');
    }

    window.eliminarItem = function(index) {
        shoppingCart.splice(index, 1);
        renderizarCarrito();
    }

    window.emitir = function(tipo) {
        if(shoppingCart.length === 0) return alert("Carrito vac√≠o");
        const clienteId = $('#cliente').val();
        const selectedClient = clientesData.find(c => c.id == clienteId);
        const metodo = $('#metodo_pago').val();

        if (tipo === 'FACTURA' && (!selectedClient || !selectedClient.ruc)) {
            return alert("Para Factura el cliente debe tener RUC.");
        }
        if (metodo === 'CREDITO' && !clienteId) {
            return alert("Debe seleccionar un cliente para ventas al cr√©dito.");
        }

        const payload = {
            cliente_id: clienteId,
            observaciones: $('#observaciones').val(),
            tipo_comprobante: tipo,
            metodo_pago: metodo, // <--- ESTO ARREGLAR√Å EL ERROR 500
            cart: shoppingCart
        };

        $.ajax({
            url: "{% url 'inventario:emitir_comprobante_ajax' %}",
            method: "POST",
            contentType: 'application/json',
            data: JSON.stringify(payload),
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }, 
            success: function(response) {
                window.open("/comprobante/" + response.comprobante_id + "/ticket/", '_blank');
                location.reload(); // Recargamos para actualizar stocks
            },
            error: function(xhr) {
                alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "Error en servidor"));
            }
        });
    }
</script>
{% endblock %}
