{% extends 'inventario/base.html' %}
{% load static %}

{% block title %}Punto de Venta Ferretero{% endblock %}

{% block extra_styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .pos-container { max-width: 100%; }
    .pos-header { background-color: #343a40; color: #ffc107; padding: 15px; border-radius: 8px 8px 0 0; }
    .total-big { font-size: 3.5rem; font-weight: 800; color: #198754; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- COLUMNA IZQUIERDA: BÚSQUEDA Y CARRITO -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body bg-light">
                <!-- BARRAS Y BÚSQUEDA -->
                <div class="row g-2 mb-2">
                    <div class="col-md-12">
                         <div class="input-group input-group-lg">
                            <span class="input-group-text bg-warning"><i class="fas fa-barcode"></i></span>
                            <input type="text" id="barcode_input" class="form-control fw-bold" placeholder="Escanear Código de Barras (Enter)" autofocus>
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <label class="fw-bold text-muted small">BUSCAR HERRAMIENTA / PRODUCTO</label>
                        <select id="producto" class="form-select form-select-lg"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="fw-bold text-muted small">CANTIDAD</label>
                        <!-- IMPORTANTE: step="any" permite decimales (metros, kilos) -->
                        <input type="number" id="cantidad" class="form-control form-control-lg text-center fw-bold" value="1" min="0.1" step="any">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button id="btn-add-to-cart" class="btn btn-primary btn-lg"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE CARRITO -->
        <div class="card shadow border-0" style="min-height: 500px;">
            <div class="card-header pos-header d-flex justify-content-between align-items-center">
                <span class="h5 mb-0"><i class="fas fa-shopping-cart"></i> DETALLE DE VENTA</span>
                <span class="badge bg-warning text-dark" id="items-count">0 Ítems</span>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-secondary">
                        <tr>
                            <th>Descripción</th>
                            <th class="text-center" width="15%">Cant.</th>
                            <th class="text-end" width="15%">P. Unit</th>
                            <th class="text-end" width="15%">Subtotal</th>
                            <th class="text-center" width="10%"></th>
                        </tr>
                    </thead>
                    <tbody id="cart-items"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- COLUMNA DERECHA: TOTALES Y CLIENTE -->
    <div class="col-lg-4">
        <!-- TARJETA TOTAL -->
        <div class="card shadow border-0 mb-4">
            <div class="card-body bg-white p-4">
                <h6 class="text-muted text-center fw-bold text-uppercase ls-1">Total a Pagar</h6>
                <div id="grand-total-display" class="total-big">S/ 0.00</div>
                <hr>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Subtotal: <span id="subtotal-display">S/ 0.00</span></span>
                    <span>IGV (18%): <span id="igv-display">S/ 0.00</span></span>
                </div>
            </div>
        </div>

        <!-- FORMULARIO CLIENTE -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3"><i class="fas fa-user"></i> Datos del Cliente</h5>
                
                <div class="mb-3">
                    <label class="form-label text-muted small fw-bold">CLIENTE</label>
                    <div class="input-group">
                        <select id="cliente" class="form-select"></select>
                        <!-- BOTÓN PLUS AGREGADO -->
                        <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#modalNuevoCliente">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-muted small">Observaciones</label>
                    <textarea id="observaciones" class="form-control" rows="2" placeholder="Opcional..."></textarea>
                </div>

                <div class="d-grid gap-3 mt-4">
                    <button class="btn btn-success btn-lg fw-bold py-3" onclick="emitir('BOLETA')">
                        <i class="fas fa-receipt me-2"></i> EMITIR BOLETA
                    </button>
                    <button class="btn btn-primary btn-lg fw-bold py-3" onclick="emitir('FACTURA')">
                        <i class="fas fa-file-invoice-dollar me-2"></i> EMITIR FACTURA
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MODAL DE REGISTRO RÁPIDO DE CLIENTE (DIVIDIDO) -->
<div class="modal fade" id="modalNuevoCliente" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-dark text-white">
                <h5 class="modal-title"><i class="fas fa-user-plus"></i> Registro Rápido de Cliente</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-cliente">
                    <div class="row">
                        <!-- SECCIÓN PERSONA -->
                        <div class="col-md-6 border-end">
                            <h6 class="fw-bold text-primary border-bottom pb-2">Persona (Boleta)</h6>
                            <div class="mb-2">
                                <label class="small fw-bold">Nombre Completo</label>
                                <input type="text" id="reg_nombre" class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <label class="small fw-bold">DNI</label>
                                <input type="text" id="reg_dni" class="form-control form-control-sm" maxlength="8">
                            </div>
                        </div>
                        <!-- SECCIÓN EMPRESA -->
                        <div class="col-md-6">
                            <h6 class="fw-bold text-success border-bottom pb-2">Empresa (Factura)</h6>
                            <div class="mb-2">
                                <label class="small fw-bold">Razón Social</label>
                                <input type="text" id="reg_razon" class="form-control form-control-sm">
                            </div>
                            <div class="mb-2">
                                <label class="small fw-bold">RUC</label>
                                <input type="text" id="reg_ruc" class="form-control form-control-sm" maxlength="11">
                            </div>
                        </div>
                    </div>
                    <div class="mt-3 pt-2 border-top">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="small fw-bold">Teléfono de Contacto</label>
                                <input type="text" id="reg_tel" class="form-control form-control-sm">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-success" id="btn-guardar-cliente-rapido">Guardar y Seleccionar</button>
            </div>
        </div>
    </div>
</div>

<div id="mensaje-ajax" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 9999;" class="alert alert-success shadow-lg"></div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let shoppingCart = [];
    const productosData = {{ productos_json|safe }};
    
    // --- NUEVA LÓGICA: clientesData ahora incluye RUC y RAZON para validación ---
    const clientesData = [ 
        { id: '', text: 'Cliente General (Público)', ruc: '', razon: '' }, 
        {% for cliente in clientes %} 
        { 
            id: {{ cliente.id }}, 
            text: "{{ cliente|escapejs }}", 
            ruc: "{{ cliente.ruc|default:'' }}", 
            razon: "{{ cliente.razon_social|default:'' }}" 
        }{% if not forloop.last %},{% endif %} 
        {% endfor %} 
    ];

    $(document).ready(function() {
        // Inicializar Select2
        $('#producto').select2({ data: productosData, placeholder: "Buscar material o herramienta...", width: '100%' });
        
        // Inicializar Clientes con la nueva data
        $('#cliente').select2({ data: clientesData, width: '100%' });

        // Evento Agregar Click
        $('#btn-add-to-cart').click(agregarAlCarrito);

        // Evento Escáner Código de Barras
        $('#barcode_input').on('keypress', function(e) {
            if (e.which == 13) { // Enter presionado
                const code = $(this).val().trim();
                if(code) {
                    const prod = productosData.find(p => p.codigo_barras === code);
                    if(prod) {
                        $('#producto').val(prod.id).trigger('change');
                        $('#cantidad').val(1);
                        agregarAlCarrito();
                        $(this).val(''); // Limpiar
                    } else {
                        alert('Producto no encontrado con código: ' + code);
                        $(this).val('');
                    }
                }
            }
        });

        // LÓGICA PARA GUARDAR CLIENTE RÁPIDO (CON SOPORTE EMPRESA)
        $('#btn-guardar-cliente-rapido').click(function() {
            const data = {
                nombre: $('#reg_nombre').val(),
                dni: $('#reg_dni').val(),
                razon: $('#reg_razon').val(),
                ruc: $('#reg_ruc').val(),
                tel: $('#reg_tel').val()
            };

            if (!data.nombre && !data.razon) return alert("Por favor ingresa un Nombre o Razón Social.");

            $.ajax({
                url: "{% url 'inventario:crear_cliente_ajax' %}",
                method: "POST",
                contentType: 'application/json',
                data: JSON.stringify(data),
                headers: { 'X-CSRFToken': '{{ csrf_token }}' },
                success: function(response) {
                    // 1. Actualizar nuestra lista local de validación
                    clientesData.push({ 
                        id: response.id, 
                        text: response.text, 
                        ruc: response.ruc, 
                        razon: response.razon 
                    });

                    // 2. Añadir al selector Select2 y seleccionar
                    const newOption = new Option(response.text, response.id, true, true);
                    $('#cliente').append(newOption).trigger('change');
                    
                    // 3. Limpiar formulario y cerrar modal
                    $('#form-nuevo-cliente')[0].reset();
                    const modalElement = document.getElementById('modalNuevoCliente');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    modal.hide();

                    alert("¡Cliente registrado y seleccionado!");
                },
                error: function(xhr) {
                    alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "No se pudo registrar"));
                }
            });
        });
    });

    function agregarAlCarrito() {
        const prodId = $('#producto').val();
        const qty = parseFloat($('#cantidad').val());

        if(!prodId) return alert("Seleccione un producto");
        if(isNaN(qty) || qty <= 0) return alert("Cantidad inválida");

        const prodInfo = productosData.find(p => p.id == prodId);
        const existingIdx = shoppingCart.findIndex(i => i.id == prodId);

        if(existingIdx > -1) {
            shoppingCart[existingIdx].quantity += qty;
        } else {
            shoppingCart.push({
                id: prodInfo.id,
                name: prodInfo.text.split(' (Stock:')[0],
                quantity: qty,
                price: parseFloat(prodInfo.precio)
            });
        }
        
        renderizarCarrito();
        $('#producto').val(null).trigger('change');
        $('#cantidad').val(1);
        $('#producto').select2('open');
    }

    function renderizarCarrito() {
        const tbody = $('#cart-items');
        tbody.empty();
        let total = 0;
        let count = 0;

        shoppingCart.forEach((item, index) => {
            const subtotal = item.quantity * item.price;
            total += subtotal;
            count++;

            const row = `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center fw-bold">${item.quantity}</td>
                    <td class="text-end">S/ ${item.price.toFixed(2)}</td>
                    <td class="text-end fw-bold">S/ ${subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="eliminarItem(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        const subtotal = total / 1.18;
        const igv = total - subtotal;

        $('#grand-total-display').text('S/ ' + total.toFixed(2));
        $('#subtotal-display').text('S/ ' + subtotal.toFixed(2));
        $('#igv-display').text('S/ ' + igv.toFixed(2));
        $('#items-count').text(count + ' Ítems');
    }

    window.eliminarItem = function(index) {
        shoppingCart.splice(index, 1);
        renderizarCarrito();
    }

    window.emitir = function(tipo) {
        if(shoppingCart.length === 0) return alert("El carrito está vacío.");

        const clienteId = $('#cliente').val();
        
        // --- NUEVA VALIDACIÓN INTELIGENTE PARA FACTURAS ---
        const selectedClient = clientesData.find(c => c.id == clienteId);

        if (tipo === 'FACTURA') {
            // Verificamos si existe el cliente y si tiene RUC + RAZON SOCIAL
            if (!selectedClient || !selectedClient.ruc || !selectedClient.razon) {
                alert("⚠️ RESTRICCIÓN DE FACTURACIÓN:\n\nEl cliente seleccionado no tiene RUC ni RAZÓN SOCIAL registrados.\n\nPara emitir una FACTURA, es obligatorio seleccionar una Empresa registrada. Si es una persona con DNI, emita una BOLETA.");
                return; // Bloquea la emisión
            }
        }
        // --------------------------------------------------

        const payload = {
            cliente_id: clienteId,
            observaciones: $('#observaciones').val(),
            tipo_comprobante: tipo,
            cart: shoppingCart
        };

        $.ajax({
            url: "{% url 'inventario:emitir_comprobante_ajax' %}",
            method: "POST",
            contentType: 'application/json',
            data: JSON.stringify(payload),
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }, 
            success: function(response) {
                if (response.comprobante_id) {
                    if (response.stocks_actualizados) {
                        response.stocks_actualizados.forEach(update => {
                            const productIdx = productosData.findIndex(p => p.id == update.id);
                            if(productIdx > -1) {
                                productosData[productIdx].stock = update.stock;
                                const baseName = productosData[productIdx].text.split(' (Stock:')[0];
                                productosData[productIdx].text = `${baseName} (Stock: ${update.stock})`;
                            }
                        });
                    }

                    $('#producto').empty().select2({ data: productosData, placeholder: "Buscar material o herramienta..." });
                    window.open("/comprobante/" + response.comprobante_id + "/ticket/", '_blank');
                    
                    $('#mensaje-ajax').text('Venta Exitosa!').fadeIn().delay(2000).fadeOut();
                    shoppingCart = [];
                    renderizarCarrito();
                    $('#cliente').val(null).trigger('change');
                    $('#observaciones').val('');
                }
            },
            error: function(xhr) {
                alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "Desconocido"));
            }
        });
    }
</script>
{% endblock %}
