{% extends 'inventario/base.html' %}
{% load static %}

{% block title %}Punto de Venta Ferretero{% endblock %}

{% block extra_styles %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
    .pos-container { max-width: 100%; }
    .pos-header { background-color: #343a40; color: #ffc107; padding: 15px; border-radius: 8px 8px 0 0; }
    .total-big { font-size: 3.5rem; font-weight: 800; color: #198754; text-align: center; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <!-- COLUMNA IZQUIERDA: BÚSQUEDA Y CARRITO -->
    <div class="col-lg-8">
        <div class="card shadow-sm border-0 mb-3">
            <div class="card-body bg-light">
                <!-- BARRAS Y BÚSQUEDA -->
                <div class="row g-2 mb-2">
                    <div class="col-md-12">
                         <div class="input-group input-group-lg">
                            <span class="input-group-text bg-warning"><i class="fas fa-barcode"></i></span>
                            <input type="text" id="barcode_input" class="form-control fw-bold" placeholder="Escanear Código de Barras (Enter)" autofocus>
                        </div>
                    </div>
                </div>
                <div class="row g-2 align-items-end">
                    <div class="col-md-8">
                        <label class="fw-bold text-muted small">BUSCAR HERRAMIENTA / PRODUCTO</label>
                        <select id="producto" class="form-select form-select-lg"></select>
                    </div>
                    <div class="col-md-2">
                        <label class="fw-bold text-muted small">CANTIDAD</label>
                        <!-- IMPORTANTE: step="any" permite decimales (metros, kilos) -->
                        <input type="number" id="cantidad" class="form-control form-control-lg text-center fw-bold" value="1" min="0.1" step="any">
                    </div>
                    <div class="col-md-2 d-grid">
                        <button id="btn-add-to-cart" class="btn btn-primary btn-lg"><i class="fas fa-plus"></i></button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABLA DE CARRITO -->
        <div class="card shadow border-0" style="min-height: 500px;">
            <div class="card-header pos-header d-flex justify-content-between align-items-center">
                <span class="h5 mb-0"><i class="fas fa-shopping-cart"></i> DETALLE DE VENTA</span>
                <span class="badge bg-warning text-dark" id="items-count">0 Ítems</span>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-secondary">
                        <tr>
                            <th>Descripción</th>
                            <th class="text-center" width="15%">Cant.</th>
                            <th class="text-end" width="15%">P. Unit</th>
                            <th class="text-end" width="15%">Subtotal</th>
                            <th class="text-center" width="10%"></th>
                        </tr>
                    </thead>
                    <tbody id="cart-items"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- COLUMNA DERECHA: TOTALES Y CLIENTE -->
    <div class="col-lg-4">
        <!-- TARJETA TOTAL -->
        <div class="card shadow border-0 mb-4">
            <div class="card-body bg-white p-4">
                <h6 class="text-muted text-center fw-bold text-uppercase ls-1">Total a Pagar</h6>
                <div id="grand-total-display" class="total-big">S/ 0.00</div>
                <hr>
                <div class="d-flex justify-content-between small text-muted">
                    <span>Subtotal: <span id="subtotal-display">S/ 0.00</span></span>
                    <span>IGV (18%): <span id="igv-display">S/ 0.00</span></span>
                </div>
            </div>
        </div>

        <!-- FORMULARIO CLIENTE -->
        <div class="card shadow-sm border-0">
            <div class="card-body p-4">
                <h5 class="card-title fw-bold mb-3"><i class="fas fa-user"></i> Datos del Cliente</h5>
                
                <div class="mb-3">
                    <select id="cliente" class="form-select"></select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label text-muted small">Observaciones</label>
                    <textarea id="observaciones" class="form-control" rows="2" placeholder="Opcional..."></textarea>
                </div>

                <div class="d-grid gap-3 mt-4">
                    <button class="btn btn-success btn-lg fw-bold py-3" onclick="emitir('BOLETA')">
                        <i class="fas fa-receipt me-2"></i> EMITIR BOLETA
                    </button>
                    <button class="btn btn-primary btn-lg fw-bold py-3" onclick="emitir('FACTURA')">
                        <i class="fas fa-file-invoice-dollar me-2"></i> EMITIR FACTURA
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="mensaje-ajax" style="display:none; position: fixed; top: 20px; right: 20px; z-index: 9999;" class="alert alert-success shadow-lg"></div>

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    let shoppingCart = [];
    const productosData = {{ productos_json|safe }};
    
    $(document).ready(function() {
        // Inicializar Select2
        $('#producto').select2({ data: productosData, placeholder: "Buscar material o herramienta...", width: '100%' });
        
        const clientesData = [ { id: '', text: 'Cliente General (Público)' }, 
            {% for cliente in clientes %} 
            { id: {{ cliente.id }}, text: "{{ cliente.nombre_completo|escapejs }}" }{% if not forloop.last %},{% endif %} 
            {% endfor %} 
        ];
        $('#cliente').select2({ data: clientesData, width: '100%' });

        // Evento Agregar Click
        $('#btn-add-to-cart').click(agregarAlCarrito);

        // Evento Escáner Código de Barras
        $('#barcode_input').on('keypress', function(e) {
            if (e.which == 13) { // Enter presionado
                const code = $(this).val().trim();
                if(code) {
                    const prod = productosData.find(p => p.codigo_barras === code);
                    if(prod) {
                        $('#producto').val(prod.id).trigger('change');
                        $('#cantidad').val(1);
                        agregarAlCarrito();
                        $(this).val(''); // Limpiar
                    } else {
                        alert('Producto no encontrado con código: ' + code);
                        $(this).val('');
                    }
                }
            }
        });
    });

    function agregarAlCarrito() {
        const prodId = $('#producto').val();
        // CAMBIO FERRETERO: parseFloat para permitir decimales
        const qty = parseFloat($('#cantidad').val());

        if(!prodId) return alert("Seleccione un producto");
        if(isNaN(qty) || qty <= 0) return alert("Cantidad inválida");

        const prodInfo = productosData.find(p => p.id == prodId);
        
        // Verificar si ya existe en el carrito
        const existingIdx = shoppingCart.findIndex(i => i.id == prodId);

        if(existingIdx > -1) {
            shoppingCart[existingIdx].quantity += qty;
        } else {
            shoppingCart.push({
                id: prodInfo.id,
                name: prodInfo.text.split(' (Stock:')[0], // Limpiar nombre visual
                quantity: qty,
                price: parseFloat(prodInfo.precio)
            });
        }
        
        renderizarCarrito();
        $('#producto').val(null).trigger('change');
        $('#cantidad').val(1);
        $('#producto').select2('open'); // Volver al buscador
    }

    function renderizarCarrito() {
        const tbody = $('#cart-items');
        tbody.empty();
        let total = 0;
        let count = 0;

        shoppingCart.forEach((item, index) => {
            const subtotal = item.quantity * item.price;
            total += subtotal;
            count++;

            const row = `
                <tr>
                    <td>${item.name}</td>
                    <td class="text-center fw-bold">${item.quantity}</td>
                    <td class="text-end">S/ ${item.price.toFixed(2)}</td>
                    <td class="text-end fw-bold">S/ ${subtotal.toFixed(2)}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-danger btn-sm" onclick="eliminarItem(${index})"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
            tbody.append(row);
        });

        // Cálculos Finales
        const subtotal = total / 1.18;
        const igv = total - subtotal;

        $('#grand-total-display').text('S/ ' + total.toFixed(2));
        $('#subtotal-display').text('S/ ' + subtotal.toFixed(2));
        $('#igv-display').text('S/ ' + igv.toFixed(2));
        $('#items-count').text(count + ' Ítems');
    }

    window.eliminarItem = function(index) {
        shoppingCart.splice(index, 1);
        renderizarCarrito();
    }

    window.emitir = function(tipo) {
        if(shoppingCart.length === 0) return alert("El carrito está vacío.");

        const payload = {
            cliente_id: $('#cliente').val(),
            observaciones: $('#observaciones').val(),
            tipo_comprobante: tipo,
            cart: shoppingCart
        };

        $.ajax({
            url: "{% url 'inventario:emitir_comprobante_ajax' %}",
            method: "POST",
            contentType: 'application/json',
            data: JSON.stringify(payload),
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }, // Usamos la variable de template directa
            success: function(response) {
                if (response.comprobante_id) {
                    // Abrir PDF
                    window.open("/comprobante/" + response.comprobante_id + "/ticket/", '_blank');
                    
                    // Mostrar mensaje
                    $('#mensaje-ajax').text('Venta Exitosa!').fadeIn().delay(2000).fadeOut();
                    
                    // Resetear
                    shoppingCart = [];
                    renderizarCarrito();
                    $('#cliente').val(null).trigger('change');
                    $('#observaciones').val('');
                }
            },
            error: function(xhr) {
                alert("Error: " + (xhr.responseJSON ? xhr.responseJSON.error : "Desconocido"));
            }
        });
    }
</script>

{% endblock %}
