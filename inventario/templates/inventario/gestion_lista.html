{% extends 'inventario/base.html' %}
{% load static %} {# Asegúrate de cargar static para los iconos, si los usas con Bootstrap #}

{% block title %}Gestionar {{ modelo_nombre_plural|title }}{% endblock %}

{% block content %}
<div class="container mt-4">

    {# Mensajes de Django, si los hubiera #}
    {% if messages %}
        <div class="container mt-3">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    {% if modelo_slug == 'productos' %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ modelo_nombre_plural|title }}</h2>
            <a href="{% url 'inventario:gestion_crear' modelo=modelo_slug %}" class="btn btn-primary">Añadir Nuevo Producto</a>
        </div>

        <!-- BUSCADOR INTELIGENTE PRODUCTOS -->
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="smart-search" class="form-control border-start-0" placeholder="Filtrar productos por nombre, ID o precio...">
            </div>
        </div>

        <div class="card shadow-sm mb-5">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">ID</th>
                            <th class="text-start ps-3">Producto</th>
                            <th class="text-center">Stock Actual</th>
                            <th class="text-center">Costo Unitario</th>
                            <th class="text-center">Precio de Venta</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for producto in objetos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td class="text-start ps-3">{{ producto.nombre }}</td>
                            <td class="text-center fw-bold">{{ producto.stock }}</td>
                            <td class="text-center">S/ {{ producto.costo|floatformat:2 }}</td>
                            <td class="text-center">S/ {{ producto.precio|floatformat:2 }}</td>
                            <td class="text-center">
                                <a href="{% url 'inventario:gestion_editar' modelo=modelo_slug pk=producto.pk %}" class="btn btn-sm btn-secondary">Editar</a>
                                <!-- BOTÓN ELIMINAR PRODUCTO -->
                                <form action="{% url 'inventario:gestion_eliminar' modelo=modelo_slug pk=producto.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Estás seguro de que deseas eliminar este producto? Esta acción no se puede deshacer.');">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="6" class="text-center p-4">No hay productos registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white"><h3 class="h4 mb-0">Edición Masiva de Productos</h3></div>
            <div class="card-body p-4">
                <ol>
                    <li>
                        <strong>Descarga la plantilla actual de tus productos.</strong> Contiene tus productos con sus IDs para una fácil edición.
                        <div class="my-2">
                            {# CAMBIO: Usamos la URL para exportar productos directamente #}
                            <a href="{% url 'inventario:exportar_productos' %}" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Exportar Productos Actuales
                            </a>
                        </div>
                    </li>
                    <li>
                        <strong>Modifica el archivo Excel.</strong> (Importante: No modifiques la columna `id` si quieres actualizar. Si la dejas vacía, se creará un nuevo registro.)
                        <div class="my-2">
                            {# CAMBIO: Ofrecemos también la plantilla vacía si prefieren empezar de cero #}
                            <a href="{% url 'inventario:descargar_plantilla' model_name='productos' %}" class="btn btn-info text-white">
                                <i class="fas fa-file-excel"></i> Descargar Plantilla Vacía
                            </a>
                        </div>
                    </li>
                    <li>
                        <strong>Sube el archivo con tus cambios.</strong>
                        <div class="my-2">
                            <form action="{% url 'inventario:importar_datos' data_type='productos' %}" method="post" enctype="multipart/form-data">
                                <div class="input-group">
                                    {% csrf_token %}
                                    <input type="file" class="form-control" name="excel_file" accept=".xlsx, .xls, .csv" required>
                                    <button class="btn btn-success" type="submit">
                                        <i class="fas fa-upload"></i> Importar Cambios
                                    </button>
                                </div>
                            </form>
                        </div>
                    </li>
                </ol>
            </div>
        </div>

    {% elif modelo_slug == 'clientes' %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ modelo_nombre_plural|title }}</h2>
            <a href="{% url 'inventario:gestion_crear' modelo=modelo_slug %}" class="btn btn-primary">Añadir Nuevo Cliente</a>
        </div>

        <!-- BUSCADOR INTELIGENTE CLIENTES -->
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="smart-search" class="form-control border-start-0" placeholder="Filtrar clientes por nombre, DNI, RUC o teléfono...">
            </div>
        </div>

        <div class="card shadow-sm mb-5">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#</th>
                            <th class="text-start ps-3">Nombre / Razón Social</th>
                            <th class="text-center">DNI o RUC</th>
                            <th class="text-center">Teléfono</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cliente in objetos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            
                            <!-- MOSTRAR NOMBRE O RAZÓN SOCIAL SEGÚN CORRESPONDA -->
                            <td class="text-start ps-3">
                                {% if cliente.razon_social %}
                                    <i class="fas fa-building text-muted me-1"></i> {{ cliente.razon_social }}
                                {% elif cliente.nombre_completo %}
                                    <i class="fas fa-user text-muted me-1"></i> {{ cliente.nombre_completo }}
                                {% else %}
                                    <span class="text-muted">Sin nombre</span>
                                {% endif %}
                            </td>

                            <!-- MOSTRAR RUC O DNI SEGÚN CORRESPONDA -->
                            <td class="text-center">
                                {% if cliente.ruc %}
                                    <span class="badge bg-light text-dark border">RUC: {{ cliente.ruc }}</span>
                                {% elif cliente.dni %}
                                    <span class="badge bg-light text-dark border">DNI: {{ cliente.dni }}</span>
                                {% else %}
                                    {{ cliente.dni_ruc|default:"--" }}
                                {% endif %}
                            </td>

                            <td class="text-center">{{ cliente.telefono|default:"--" }}</td>
                            <td class="text-center">
                                <a href="{% url 'inventario:gestion_editar' modelo=modelo_slug pk=cliente.pk %}" class="btn btn-sm btn-secondary">Editar</a>
                                <form action="{% url 'inventario:gestion_eliminar' modelo=modelo_slug pk=cliente.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Seguro que deseas eliminar este cliente?');">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center p-4">No hay clientes registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white"><h3 class="h4 mb-0">Importación Masiva de Clientes</h3></div>
            <div class="card-body p-4">
                <ol>
                    <li>
                        <strong>Descarga la plantilla.</strong>
                        <div class="my-2">
                            {# CAMBIO: Usamos la URL genérica para descargar plantillas #}
                            <a href="{% url 'inventario:descargar_plantilla' model_name='clientes' %}" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Descargar Plantilla
                            </a>
                        </div>
                    </li>
                    <li><strong>Llena el archivo Excel</strong> con los datos de tus clientes.</li>
                    <li>
                        <strong>Sube el archivo completo.</strong>
                        <div class="my-2">
                            {# CAMBIO: Apuntamos a la nueva vista general de importación #}
                            <form action="{% url 'inventario:importar_datos' data_type='clientes' %}" method="post" enctype="multipart/form-data">
                                <div class="input-group">
                                    {% csrf_token %}
                                    <input type="file" class="form-control" name="excel_file" accept=".xlsx, .xls, .csv" required>
                                    <button class="btn btn-success" type="submit">
                                        <i class="fas fa-upload"></i> Importar Archivo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </li>
                </ol>
            </div>
        </div>
    
    {% elif modelo_slug == 'proveedores' %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ modelo_nombre_plural|title }}</h2>
            <a href="{% url 'inventario:gestion_crear' modelo=modelo_slug %}" class="btn btn-primary">Añadir Nuevo Proveedor</a>
        </div>

        <!-- BUSCADOR INTELIGENTE PROVEEDORES -->
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="smart-search" class="form-control border-start-0" placeholder="Filtrar proveedores por razón social o RUC...">
            </div>
        </div>

        <div class="card shadow-sm mb-5">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#</th>
                            <th class="text-start ps-3">Razón Social</th>
                            <th class="text-center">RUC</th>
                            <th class="text-center">Teléfono</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for proveedor in objetos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td class="text-start ps-3">{{ proveedor.razon_social }}</td>
                            <td class="text-center">{{ proveedor.ruc|default:"--" }}</td>
                            <td class="text-center">{{ proveedor.telefono|default:"--" }}</td>
                            <td class="text-center">
                                <a href="{% url 'inventario:gestion_editar' modelo=modelo_slug pk=proveedor.pk %}" class="btn btn-sm btn-secondary">Editar</a>
                                <!-- BOTÓN ELIMINAR PROVEEDOR -->
                                <form action="{% url 'inventario:gestion_eliminar' modelo=modelo_slug pk=proveedor.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Seguro que deseas eliminar este proveedor?');">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="5" class="text-center p-4">No hay proveedores registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white"><h3 class="h4 mb-0">Importación Masiva de Proveedores</h3></div>
            <div class="card-body p-4">
                <ol>
                    <li>
                        <strong>Descarga la plantilla.</strong>
                        <div class="my-2">
                            {# CAMBIO: Usamos la URL genérica para descargar plantillas #}
                            <a href="{% url 'inventario:descargar_plantilla' model_name='proveedores' %}" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Descargar Plantilla
                            </a>
                        </div>
                    </li>
                    <li><strong>Llena el archivo Excel</strong> con los datos de tus proveedores.</li>
                    <li>
                        <strong>Sube el archivo completo.</strong>
                        <div class="my-2">
                            {# CAMBIO: Apuntamos a la nueva vista general de importación #}
                            <form action="{% url 'inventario:importar_datos' data_type='proveedores' %}" method="post" enctype="multipart/form-data">
                                <div class="input-group">
                                    {% csrf_token %}
                                    <input type="file" class="form-control" name="excel_file" accept=".xlsx, .xls, .csv" required>
                                    <button class="btn btn-success" type="submit">
                                        <i class="fas fa-upload"></i> Importar Archivo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </li>
                </ol>
            </div>
        </div>
    
    {% elif modelo_slug == 'compras' %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ modelo_nombre_plural|title }}</h2>
            <a href="{% url 'inventario:gestion_crear' modelo=modelo_slug %}" class="btn btn-primary">Añadir Nueva Compra</a>
        </div>

        <!-- BUSCADOR INTELIGENTE COMPRAS -->
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="smart-search" class="form-control border-start-0" placeholder="Filtrar compras por proveedor, producto o fecha...">
            </div>
        </div>

        <div class="card shadow-sm mb-5">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#</th>
                            <th class="text-start ps-3">Proveedor</th>
                            <th>Producto</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-center">Costo Total</th>
                            <th class="text-center">Fecha</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for compra in objetos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td class="text-start ps-3">{{ compra.proveedor.razon_social }}</td>
                            <td>{{ compra.producto.nombre }}</td>
                            <td class="text-center">{{ compra.cantidad }}</td>
                            <td class="text-center">S/ {{ compra.costo_total|floatformat:2 }}</td>
                            <td class="text-center">{{ compra.fecha_de_compra|date:"d/m/Y H:i" }}</td>
                            <td class="text-center">
                                <a href="{% url 'inventario:gestion_editar' modelo=modelo_slug pk=compra.pk %}" class="btn btn-sm btn-secondary">Editar</a>
                                <!-- BOTÓN ELIMINAR COMPRA (RESTA STOCK) -->
                                <form action="{% url 'inventario:gestion_eliminar' modelo=modelo_slug pk=compra.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('¡ATENCIÓN! Al eliminar esta compra, el stock del producto se restará automáticamente. ¿Deseas continuar?');">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="7" class="text-center p-4">No hay compras registradas.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card shadow-sm">
            <div class="card-header bg-success text-white">
                <h3 class="h4 mb-0">Importar Compras Masivamente</h3>
            </div>
            <div class="card-body p-4">
                <p>Sigue estos pasos para registrar múltiples compras a la vez:</p>
                <ol>
                    <li>
                        <strong>Descarga la plantilla de Excel.</strong> Contiene las columnas exactas que necesitas.
                        <div class="my-2">
                            {# CAMBIO: Usamos la URL genérica para descargar plantillas #}
                            <a href="{% url 'inventario:descargar_plantilla' model_name='compras' %}" class="btn btn-secondary">
                                <i class="fas fa-download"></i> Descargar Plantilla
                            </a>
                        </div>
                    </li>
                    <li>
                        <strong>Llena el archivo Excel</strong> con los datos de tus compras.
                        <br><small><strong>Nota:</strong> Para el producto, usa el "Código de Barras". Para el proveedor, usa su "RUC".</small>
                    </li>
                    <li>
                        <strong>Sube el archivo completo.</strong> El sistema procesará las compras y actualizará tu stock.
                        <div class="my-2">
                            <form action="{% url 'inventario:importar_datos' data_type='compras' %}" method="post" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="input-group">
                                    <input type="file" class="form-control" name="excel_file" accept=".xlsx, .xls, .csv" required>
                                    <button class="btn btn-success" type="submit">
                                        <i class="fas fa-upload"></i> Importar Archivo
                                    </button>
                                </div>
                            </form>
                        </div>
                    </li>
                </ol>
            </div>
        </div>

    {% elif modelo_slug == 'comprobantes' %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ modelo_nombre_plural|title }}</h2>
            <a href="{% url 'inventario:exportar_comprobantes' %}" class="btn btn-success">
                <i class="fas fa-file-excel"></i> Exportar a Excel
            </a>
        </div>

        <!-- BUSCADOR INTELIGENTE COMPROBANTES -->
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="smart-search" class="form-control border-start-0" placeholder="Filtrar por número, serie, cliente o estado...">
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#</th>
                            <th>Tipo</th>
                            <th>Serie-Número</th>
                            <th>Cliente</th>
                            <th>Fecha</th>
                            <th>Total Final</th>
                            <th>Estado</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for comprobante in objetos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td>{{ comprobante.get_tipo_comprobante_display }}</td>
                            <td>{{ comprobante.serie }}-{{ comprobante.numero }}</td>
                            <td>{{ comprobante.cliente.nombre_completo|default:"Público General" }}</td>
                            <td>{{ comprobante.fecha_emision|date:"d/m/Y H:i" }}</td>
                            <td>S/ {{ comprobante.total_final|floatformat:2 }}</td>
                            <td>{{ comprobante.estado }}</td>
                            <td class="text-center">
                                <a href="{% url 'inventario:vista_ticket_comprobante' comprobante.id %}" target="_blank" class="btn btn-sm btn-info text-white me-1">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'inventario:descargar_comprobante_pdf' comprobante_id=comprobante.id %}" class="btn btn-sm btn-danger me-1" title="Descargar PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </a>
                                <form action="{% url 'inventario:eliminar_venta' comprobante_id=comprobante.id %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-warning" onclick="return confirm('¿Estás seguro de que quieres anular/eliminar este comprobante y restaurar el stock? Esta acción es irreversible.');" title="Anular/Eliminar">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="8" class="text-center p-4">No hay comprobantes registrados.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% else %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2>{{ modelo_nombre_plural|title }}</h2>
            <a href="{% url 'inventario:gestion_crear' modelo=modelo_slug %}" class="btn btn-primary">Añadir Nuevo</a>
        </div>

        <!-- BUSCADOR INTELIGENTE OTROS -->
        <div class="mb-3">
            <div class="input-group">
                <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="smart-search" class="form-control border-start-0" placeholder="Filtrar registros...">
            </div>
        </div>

        <div class="card shadow-sm mb-5">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead class="table-dark">
                        <tr>
                            <th class="text-center">#</th>
                            <th>Nombre / Detalle</th>
                            <th class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for obj in objetos %}
                        <tr>
                            <td class="text-center fw-bold">{{ forloop.counter }}</td>
                            <td>{{ obj }}</td>
                            <td class="text-center">
                                <a href="{% url 'inventario:gestion_editar' modelo=modelo_slug pk=obj.pk %}" class="btn btn-sm btn-secondary">Editar</a>
                                <form action="{% url 'inventario:gestion_eliminar' modelo=modelo_slug pk=obj.pk %}" method="post" class="d-inline">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('¿Seguro que deseas eliminar este registro?');">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% empty %}
                        <tr><td colspan="3" class="text-center p-4">No hay registros.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('smart-search');
        // Seleccionamos todas las filas de la tabla presente en la página
        const tableRows = document.querySelectorAll('table tbody tr');

        if (searchInput) {
            searchInput.addEventListener('keyup', function(e) {
                const term = e.target.value.toLowerCase();

                tableRows.forEach(row => {
                    // Ignoramos la fila de "No hay registros" si existe
                    if (row.cells.length === 1 || row.innerText.includes('No hay')) {
                        return;
                    }

                    // El buscador revisa el contenido de texto de toda la fila
                    const rowText = row.innerText.toLowerCase();
                    
                    if (rowText.indexOf(term) !== -1) {
                        row.style.display = ''; // Mostrar fila
                    } else {
                        row.style.display = 'none'; // Ocultar fila
                    }
                });
            });
        }
    });
</script>
{% endblock %}
